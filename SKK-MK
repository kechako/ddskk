;;; -*-Emacs-Lisp-*-

;; SKK-MK: installer for SKK.
;; Copyright (C) 1999 Mikio Nakajima <minakaji@osaka.email.ne.jp>

;; Author: Mikio Nakajima <minakaji@osaka.email.ne.jp>
;; Maintainer: Mikio Nakajima <minakaji@osaka.email.ne.jp>
;; Version: $Id: SKK-MK,v 1.6 1999/09/15 15:07:41 minakaji Exp $
;; Last Modified: $Date: 1999/09/15 15:07:41 $

;; Commentary
;;
;; Those values of variables below are default configurations.
;; If you would like to change some of those, you can edit SKK-CFG.
;;
;;              DO NOT EDIT THIS FILE DIRECTLY!
;;
;; Please note that as to `PREFIX', `LISPDIR', `PACKAGEDIR' and
;; `VERSION_SPECIFIC_LISPDIR', definitions in Makefile (but other than
;; `NONE') overwrite variables defined in SKK-MK and SKK-CFG.
;;
;; Variable sections are all three parts.  GENERIC VARIABLE section,
;; NON-PACKAGE INSTALL RELATED VARIABLE section, and PACKAGE INSTALL
;; RELATED VARIABLE section.
;;
;; You can confirm target directories without an actual installation
;; by M-x SKK-MK-what-where or M-x SKK-MK-what-where-package after
;; load this program.

;;; Code:
(defvar default-load-path load-path)
(and (expand-file-name "../../site-lisp/apel" data-directory)
     (setq load-path (cons
		      (expand-file-name "../../site-lisp/apel" data-directory)
		      load-path )))
(if (and (boundp 'LISPDIR) LISPDIR)
    (progn
      (or (member LISPDIR default-load-path)
	  (setq default-load-path (cons LISPDIR default-load-path)) )
      (or (member LISPDIR load-path) (setq load-path (cons LISPDIR load-path)))
      (or (member (expand-file-name "apel" LISPDIR) load-path)
	  (setq load-path (cons (expand-file-name "apel" LISPDIR) load-path)) )))
(setq load-path (cons (expand-file-name ".") load-path))
;; APEL required.
(require 'install)

;; install.el is required before defining default variables.
;; GENERIC VARIABLE.
(defvar DOCDIR "./doc")
(defvar ETCDIR "./etc")
(defvar SKK-INFOS '("skk.info" "skk.info-1" "skk.info-2" "skk.info-3" "skk.info-4"))
(defvar SKK-MODULES
  (let ((list '(queue-m stack-m skk-foreword
			skk-gadget skk-isearch skk-auto skk-comp
			skk-kakasi skk-kcode skk-leim skk-look
			skk-num skk-obsolete skk-server skk-tut
			skk skk-autoloads
			;; EXPERIMENTAL
			skk-rdbms skk-study
			;; VIP 3.7
			;; vip
			)))
    (condition-case nil
	(and (require 'viper) (setq list (nconc list (list 'skk-viper))))
      (error) )
    (and (or (featurep 'gdbm) (featurep 'dbm) (featurep 'berkdb)
	     (featurep 'berkeley-db) )
	 (setq list (nconc list (list 'skk-dbm))) )
    list ))
(defvar SKK_PREFIX "skk")
(defvar SKK-TEXIS '("skk.texi"))
(defvar SKK-TUTORIALS '("SKK.tut" "SKK.tut.E"))
(defvar VERSION_SPECIFIC_LISPDIR nil)

;; NON-PACKAGE INSTALL RELATED VARIABLE.
;; `install-prefix' is defined in install.el of APEL.
;; Maybe it is `/usr/local'.
(defvar PREFIX install-prefix)
;; automatically detected.
(defvar LISPDIR (install-detect-elisp-directory PREFIX))
(defvar SKK_DATADIR (expand-file-name
		     SKK_PREFIX (expand-file-name "share" PREFIX) ))
(defvar SKK_INFODIR (expand-file-name "info" PREFIX))
(defvar SKK_LISPDIR (expand-file-name SKK_PREFIX LISPDIR))

;; PACKAGE INSTALL RELATED VARIABLE.
(defvar PACKAGEDIR
  (if (boundp 'early-packages)
      (let ((dirs
	     (append (if early-package-load-path early-packages)
		     (if late-package-load-path late-packages)
		     (if last-package-load-path last-packages) ))
	    dir )
	(while (not (file-exists-p (setq dir (car dirs))))
	  (setq dirs (cdr dirs)) )
	dir )))

(defvar SKK_PACKAGE_DATADIR (expand-file-name
			     SKK_PREFIX (expand-file-name "etc" PACKAGEDIR) ))
(defvar PACKAGE_INFODIR (expand-file-name "info" PACKAGEDIR))
(defvar SKK_PACKAGE_LISPDIR (expand-file-name
			     SKK_PREFIX (expand-file-name "lisp" PACKAGEDIR) ))

;; constants.
(defconst SKK-MK-texinfo-coding-system
  (if (or (string-match "XEmacs" emacs-version)
	  (and (boundp 'mule-version)
	       (or (string< "4.0" mule-version) (string< "3.0" mule-version)) ))
      'junet
    *junet* ))

;; load user custom file if exists.
(load "./SKK-CFG" t nil t)
(princ (format "SKK-MODULES=%s\n" SKK-MODULES))

(if (and VERSION_SPECIFIC_LISPDIR
	 (null (member VERSION_SPECIFIC_LISPDIR load-path)) )
    (setq load-path (cons VERSION_SPECIFIC_LISPDIR load-path)) )

(defun SKK-MK-config ()
  (let (prefix lisp-dir version-specific-lisp-dir)
    (and (setq prefix (car command-line-args-left))
	 ;; overwrite as specified in Makefile.
	 (or (string-equal "NONE" prefix) (setq PREFIX prefix)))
    (setq command-line-args-left (cdr command-line-args-left))
    (and (setq lisp-dir (car command-line-args-left))
	 ;; overwrite as specified in Makefile.
	 (or (string-equal "NONE" lisp-dir) (setq LISPDIR lisp-dir)) )
    (setq command-line-args-left (cdr command-line-args-left))
    (and (setq version-specific-lisp-dir (car command-line-args-left))
	 (if (not (string-equal "NONE" version-specific-lisp-dir))
	     ;; overwrite as specified in Makefile.
	     (setq VERSION_SPECIFIC_LISPDIR version-specific-lisp-dir)
	   ;; not overwrite a variable specified by user.
	   (defvar VERSION_SPECIFIC_LISPDIR
	     (install-detect-elisp-directory PREFIX nil 'version-specific) ))
	 (princ (format "VERSION_SPECIFIC_LISPDIR=%s\n"
			VERSION_SPECIFIC_LISPDIR )))
    (setq command-line-args-left (cdr command-line-args-left))
    (princ (format "PREFIX=%s\n" PREFIX)) ))

(defun SKK-MK-install ()
  (SKK-MK-compile)
  ;; install Emacs Lisp programs.
  (install-elisp-modules SKK-MODULES "." SKK_LISPDIR)
  ;; install infos.
  (cd DOCDIR)
  (if (or (not (file-exists-p (expand-file-name (car SKK-INFOS) ".")))
	  (file-newer-than-file-p (expand-file-name (car SKK-TEXIS) ".")
				  (expand-file-name (car SKK-INFOS) ".") ))
      (SKK-MK-texinfo-format SKK-TEXIS) )
  (install-files SKK-INFOS "." SKK_INFODIR nil t nil)
  (cd "..")
  ;; install tutorials.
  (cd ETCDIR)
  (install-files SKK-TUTORIALS "." SKK_DATADIR nil t nil)
  (cd "..") )

(defun SKK-MK-config-package ()
  (or (featurep 'xemacs) (error "This directive is only for XEmacs."))
  (let ((package-dir (car command-line-args-left)))
    ;; overwrite as specified in Makefile.
    (or (string= "NONE" package-dir) (setq PACKAGEDIR package-dir))
    (setq command-line-args-left (cdr command-line-args-left))
    ;; skk-autoloads.el is not necessary for XEmacs package install.
    (setq SKK-MODULES (delq 'skk-autoloads SKK-MODULES))
    (princ (format "PACKAGEDIR=%s\n" PACKAGEDIR)) ))

(defun SKK-MK-install-package ()
  (SKK-MK-config-package)
  (if (not (file-exists-p SKK_PACKAGE_LISPDIR))
      (make-directory SKK_PACKAGE_LISPDIR t)
    (let ((files
	   ;; (directory-files SKK_PACKAGE_LISPDIR 'full nil 'nosort t) ))
	   (list (expand-file-name "auto-autoloads.el" SKK_PACKAGE_LISPDIR)
		 (expand-file-name "custom-load.el" SKK_PACKAGE_LISPDIR)
		 ;; unnecessary.
		 (expand-file-name "skk-autoloads.el" SKK_PACKAGE_LISPDIR) 
		 ;; obsolete.
		 (expand-file-name "skk-vars.el" SKK_PACKAGE_LISPDIR) )))
      (while files
	(condition-case nil
	    ;; clean up trouble maker.
	    (progn
	      (delete-file (car files))
	      (delete-file (concat (car files) "c")) )
	  (error) )
	(setq files (cdr files)) )))
  (or (file-exists-p SKK_PACKAGE_DATADIR)
      (make-directory SKK_PACKAGE_DATADIR t) )
  (or (file-exists-p PACKAGE_INFODIR)
      (make-directory PACKAGE_INFODIR t) )
  ;; install Emacs Lisp programs.
  (compile-elisp-modules SKK-MODULES ".")
  (install-elisp-modules SKK-MODULES	"." SKK_PACKAGE_LISPDIR)
  (setq autoload-package-name "skk")
  (add-to-list 'command-line-args-left SKK_PACKAGE_LISPDIR)
  (batch-update-directory)
  (add-to-list 'command-line-args-left SKK_PACKAGE_LISPDIR)
  (Custom-make-dependencies)
  (byte-compile-file (expand-file-name "auto-autoloads.el" SKK_PACKAGE_LISPDIR))
  (byte-compile-file (expand-file-name "custom-load.el" SKK_PACKAGE_LISPDIR))
  ;; install infos.
  (cd DOCDIR)
  (if (or (not (file-exists-p (expand-file-name (car SKK-INFOS) ".")))
	  (file-newer-than-file-p (expand-file-name (car SKK-TEXIS) ".")
				  (expand-file-name (car SKK-INFOS) ".") ))
      (SKK-MK-texinfo-format SKK-TEXIS) )
  (install-files SKK-INFOS "." PACKAGE_INFODIR nil t nil)
  (cd "..")
  ;; install tutorials.
  (cd ETCDIR)
  (install-files SKK-TUTORIALS "." SKK_PACKAGE_DATADIR nil t nil)
  (cd "..") )

(defun SKK-MK-compile ()
  (SKK-MK-config)
  (compile-elisp-modules SKK-MODULES ".") )


(defun SKK-MK-texinfo-format (targets)
  (let (x obuf beg)
    (while targets
      (setq x (car targets))
      (find-file x)
      (setq obuf (current-buffer))
      ;; Emacs20.2's default is 'raw-text-unix.
      (and (fboundp 'set-default-buffer-file-coding-system)
	   (set-default-buffer-file-coding-system SKK-MK-texinfo-coding-system) )
      (condition-case nil
	  (texinfo-format-buffer)
	(error				; one more try with no @direntry
	 ;;(kill-buffer (current-buffer))
	 (set-buffer obuf)
	 (goto-char (point-min))
	 (message "Format failed. Trying no @direntry")
	 (when (re-search-forward "@direntry" nil t)
	   (setq beg (match-beginning 0))
	   (when (re-search-forward "@end direntry" nil t)
	     (delete-region beg (match-end 0))))
	 (texinfo-format-buffer) ))
      ;; Emacs20.2's default is 'raw-text-unix.
      (and (fboundp 'set-buffer-file-coding-system)
	   (set-buffer-file-coding-system SKK-MK-texinfo-coding-system) )
      (save-buffer)
      (kill-buffer (current-buffer))	; info
      (kill-buffer obuf)		; texi
      (setq targets (cdr targets)) )))

(defun SKK-MK-what-where ()
  (interactive)
  (SKK-MK-config)
  (let ((string
	 (format "
SKK modules:
  %s
  -> %s

SKK infos:
  %s
  -> %s

SKK tutorials:
  %s
  -> %s
"
		 (mapconcat 'symbol-name SKK-MODULES ", ")
		 SKK_LISPDIR
		 (mapconcat 'identity SKK-INFOS ", ")
		 SKK_INFODIR
		 (mapconcat 'identity SKK-TUTORIALS ", ")
		 SKK_DATADIR )))
    (if (interactive-p)
	(progn (with-output-to-temp-buffer "*What where*" (princ string))
	       (message "") )
      (princ string) )))

(defun SKK-MK-what-where-package ()
  (interactive)
  (SKK-MK-config-package)
  (let ((string
	 (format "
SKK modules:
  %s
  -> %s

SKK infos:
  %s
  -> %s

SKK tutorials:
  %s
  -> %s
"
		 (mapconcat 'symbol-name SKK-MODULES ", ")
		 SKK_PACKAGE_LISPDIR
		 (mapconcat 'identity SKK-INFOS ", ")
		 PACKAGE_INFODIR
		 (mapconcat 'identity SKK-TUTORIALS ", ")
		 SKK_PACKAGE_DATADIR )))
    (if (interactive-p)
	(progn (with-output-to-temp-buffer "*What where*" (princ string))
	       (message "") )
      (princ string) )))

;;; SKK-MK ends here
