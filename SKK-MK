;;; -*-Emacs-Lisp-*-

;; SKK-MK: installer for SKK.
;; Copyright (C) 1999 Mikio Nakajima <minakaji@osaka.email.ne.jp>

;; Author: Mikio Nakajima <minakaji@osaka.email.ne.jp>
;; Maintainer: Mikio Nakajima <minakaji@osaka.email.ne.jp>
;; Version: $Id: SKK-MK,v 1.12 1999/09/17 01:29:09 minakaji Exp $
;; Last Modified: $Date: 1999/09/17 01:29:09 $

;; Commentary
;;
;; Those values of variables below are default configurations.
;; If you would like to change some of those, you can edit SKK-CFG.
;;
;;              DO NOT EDIT THIS FILE DIRECTLY!
;;
;; Please note that as to `PREFIX', `LISPDIR', `PACKAGEDIR' and
;; `VERSION_SPECIFIC_LISPDIR', definitions in Makefile (but other than
;; `NONE') overwrite variables defined in SKK-MK and SKK-CFG.
;;
;; Variable sections are all three parts.  GENERIC VARIABLE section,
;; NON-PACKAGE INSTALL RELATED VARIABLE section, and PACKAGE INSTALL
;; RELATED VARIABLE section.
;;
;; You can confirm target directories without an actual installation
;; by M-x SKK-MK-what-where or M-x SKK-MK-what-where-package after
;; load this program.

;;; Code:
(defvar default-load-path load-path)
(and (expand-file-name "../../site-lisp/apel" data-directory)
     (setq load-path (cons
		      (expand-file-name "../../site-lisp/apel" data-directory)
		      load-path )))
(if (and (boundp 'LISPDIR) LISPDIR)
    (progn
      (or (member LISPDIR default-load-path)
	  (setq default-load-path (cons LISPDIR default-load-path)) )
      (or (member LISPDIR load-path) (setq load-path (cons LISPDIR load-path)))
      (or (member (expand-file-name "apel" LISPDIR) load-path)
	  (setq load-path (cons (expand-file-name "apel" LISPDIR) load-path)) )))
(setq load-path (cons (expand-file-name ".") load-path))

;; install.el is required AFTER seaching APEL installed dirctory and add it to 
;; load-path, and BEFORE defining default variables.
(require 'install)

;; GENERIC VARIABLE.
(defvar SKK-MK-cleanup-trouble-makers nil
  "*Non-nil means clean up already installed SKK package configration files.
If symbol `backup' makes backup files named `xxxx.BAK'.
It is related only to XEmacs package install.

Deleted files are `auto-autoloads.el', `custom-load.el', `skk-autoloads.el',
`skk-vars.el' which exist in `package-locations', or `load-path' if
`package-locations'does not exist." )
(defvar DOCDIR "./doc")
(defvar ETCDIR "./etc")
(defvar SKK_INFOS '("skk.info" "skk.info-1" "skk.info-2" "skk.info-3" "skk.info-4"))
(defvar SKK_MODULES
  (let ((list '(queue-m stack-m skk-foreword
			skk-gadget skk-isearch skk-auto skk-comp
			skk-kakasi skk-kcode skk-leim skk-look
			skk-num skk-obsolete skk-server skk-tut
			skk skk-autoloads
			;; EXPERIMENTAL
			skk-rdbms skk-study
			;; VIP 3.7
			;; vip
			)))
    (condition-case nil
	(and (require 'viper) (setq list (nconc list (list 'skk-viper))))
      (error) )
    (and (or (featurep 'gdbm) (featurep 'dbm) (featurep 'berkdb)
	     (featurep 'berkeley-db) )
	 (setq list (nconc list (list 'skk-dbm))) )
    list ))
(defvar SKK_PREFIX "skk")
(defvar SKK_TEXIS '("skk.texi"))
(defvar SKK_TUTORIALS '("SKK.tut" "SKK.tut.E"))
(defvar VERSION_SPECIFIC_LISPDIR nil)

;; NON-PACKAGE INSTALL RELATED VARIABLE.
;; `install-prefix' is defined in install.el of APEL.
;; Maybe it is `/usr/local'.
(defvar PREFIX install-prefix)
;; automatically detected.
(defvar LISPDIR (install-detect-elisp-directory PREFIX))
(defvar SKK_DATADIR (expand-file-name
		     SKK_PREFIX (expand-file-name "share" PREFIX) ))
(defvar SKK_INFODIR (expand-file-name "info" PREFIX))
(defvar SKK_LISPDIR (expand-file-name SKK_PREFIX LISPDIR))

;; PACKAGE INSTALL RELATED VARIABLE.
(defvar PACKAGEDIR
  (if (boundp 'early-packages)
      (let ((dirs
	     (append (if early-package-load-path early-packages)
		     (if late-package-load-path late-packages)
		     (if last-package-load-path last-packages) ))
	    dir )
	(while (not (file-exists-p (setq dir (car dirs))))
	  (setq dirs (cdr dirs)) )
	dir )))

(defvar PACKAGE_INFODIR (expand-file-name "info" PACKAGEDIR))
(defvar SKK_PACKAGE_DATADIR (expand-file-name
			     SKK_PREFIX (expand-file-name "etc" PACKAGEDIR) ))
(defvar SKK_PACKAGE_LISPDIR (expand-file-name
			     SKK_PREFIX (expand-file-name "lisp" PACKAGEDIR) ))

;; constants.
(defconst SKK-MK-running-xemacs (string-match "XEmacs" emacs-version))

(defconst SKK-MK-texinfo-coding-system
  (if (or SKK-MK-running-xemacs 
	  (and (boundp 'mule-version)
	       (or (string< "4.0" mule-version) (string< "3.0" mule-version)) ))
      'junet
    *junet* ))

;; load user custom file if exists.
(load "./SKK-CFG" t nil t)
(princ (format "SKK_MODULES=%s\n" SKK_MODULES))

(if (and VERSION_SPECIFIC_LISPDIR
	 (null (member VERSION_SPECIFIC_LISPDIR load-path)) )
    (setq load-path (cons VERSION_SPECIFIC_LISPDIR load-path)) )

(defun SKK-MK-config ()
  (let (prefix lisp-dir version-specific-lisp-dir)
    (and (setq prefix (car command-line-args-left))
	 ;; overwrite as specified in Makefile.
	 (if (string-equal "NONE" prefix)
	     nil
	   (setq PREFIX prefix
		 LISPDIR (install-detect-elisp-directory PREFIX)
		 SKK_DATADIR (expand-file-name
			      SKK_PREFIX (expand-file-name "share" PREFIX) )
		 SKK_INFODIR (expand-file-name "info" PREFIX) )))
    (setq command-line-args-left (cdr command-line-args-left))
    (and (setq lisp-dir (car command-line-args-left))
	 ;; overwrite as specified in Makefile.
	 (if (string-equal "NONE" lisp-dir)
	     nil
	   (setq LISPDIR lisp-dir
		 SKK_LISPDIR (expand-file-name SKK_PREFIX LISPDIR)) ))
    (setq command-line-args-left (cdr command-line-args-left))
    (and (setq version-specific-lisp-dir (car command-line-args-left))
	 (if (not (string-equal "NONE" version-specific-lisp-dir))
	     ;; overwrite as specified in Makefile.
	     (setq VERSION_SPECIFIC_LISPDIR version-specific-lisp-dir)
	   ;; not overwrite a variable specified by user.
	   (defvar VERSION_SPECIFIC_LISPDIR
	     (install-detect-elisp-directory PREFIX nil 'version-specific) ))
	 (princ (format "VERSION_SPECIFIC_LISPDIR=%s\n"
			VERSION_SPECIFIC_LISPDIR )))
    (setq command-line-args-left (cdr command-line-args-left))
    (princ (format "PREFIX=%s\n" PREFIX)) ))

(defun SKK-MK-compile ()
  (SKK-MK-config)
  (compile-elisp-modules SKK_MODULES ".") )

(defun SKK-MK-install ()
  (SKK-MK-compile)
  (if (and SKK-MK-running-xemacs SKK-MK-cleanup-trouble-makers)
      (SKK-MK-cleanup-trouble-makers
       (eq SKK-MK-cleanup-trouble-makers 'backup) ))
  (setq DOCDIR (expand-file-name DOCDIR)
	ETCDIR (expand-file-name ETCDIR) )
  ;; install Emacs Lisp programs.
  (install-elisp-modules SKK_MODULES "." SKK_LISPDIR)
  ;; install infos.
  (if (or (not (file-exists-p (expand-file-name (car SKK_INFOS) DOCDIR)))
	  (file-newer-than-file-p (expand-file-name (car SKK_TEXIS) DOCDIR)
				  (expand-file-name (car SKK_INFOS) DOCDIR) ))
      (SKK-MK-texinfo-format SKK_TEXIS) )
  (install-files SKK_INFOS DOCDIR SKK_INFODIR nil t nil)
  ;; install tutorials.
  (install-files SKK_TUTORIALS ETCDIR SKK_DATADIR nil t nil) )

(defun SKK-MK-config-package ()
  (or (featurep 'xemacs) (error "This directive is only for XEmacs."))
  (let ((package-dir (car command-line-args-left)))
    ;; overwrite as specified in Makefile.
    (if (not (string= "NONE" package-dir))
	(setq PACKAGEDIR package-dir
	      PACKAGE_INFODIR (expand-file-name "info" PACKAGEDIR)
	      SKK_PACKAGE_DATADIR (expand-file-name
				   SKK_PREFIX (expand-file-name "etc" PACKAGEDIR) )
	      SKK_PACKAGE_LISPDIR (expand-file-name
				   SKK_PREFIX (expand-file-name "lisp" PACKAGEDIR) )))
    (setq command-line-args-left (cdr command-line-args-left))
    ;; skk-autoloads.el is not necessary for XEmacs package install.
    (setq SKK_MODULES (delq 'skk-autoloads SKK_MODULES))
    (princ (format "PACKAGEDIR=%s\n" PACKAGEDIR)) ))

(defun SKK-MK-install-package ()
  (SKK-MK-config-package)
  (if SKK-MK-cleanup-trouble-makers
      (SKK-MK-cleanup-trouble-makers
       (eq SKK-MK-cleanup-trouble-makers 'backup) ))
  (or (file-exists-p SKK_PACKAGE_LISPDIR)
      (make-directory SKK_PACKAGE_LISPDIR t) )
  (or (file-exists-p SKK_PACKAGE_DATADIR)
      (make-directory SKK_PACKAGE_DATADIR t) )
  (or (file-exists-p PACKAGE_INFODIR)
      (make-directory PACKAGE_INFODIR t) )
  ;; install Emacs Lisp programs.
  (compile-elisp-modules SKK_MODULES ".")
  (install-elisp-modules SKK_MODULES "." SKK_PACKAGE_LISPDIR)
  (setq autoload-package-name "skk")
  (add-to-list 'command-line-args-left SKK_PACKAGE_LISPDIR)
  (batch-update-directory)
  (add-to-list 'command-line-args-left SKK_PACKAGE_LISPDIR)
  (Custom-make-dependencies)
  (byte-compile-file (expand-file-name "auto-autoloads.el" SKK_PACKAGE_LISPDIR))
  (byte-compile-file (expand-file-name "custom-load.el" SKK_PACKAGE_LISPDIR))
  ;; install infos.
  (if (or (not (file-exists-p (expand-file-name (car SKK_INFOS) DOCDIR)))
	  (file-newer-than-file-p (expand-file-name (car SKK_TEXIS) DOCDIR)
				  (expand-file-name (car SKK_INFOS) DOCDIR) ))
      (SKK-MK-texinfo-format SKK_TEXIS) )
  (install-files SKK_INFOS DOCDIR PACKAGE_INFODIR nil t nil)
  ;; install tutorials.
  (install-files SKK_TUTORIALS ETCDIR SKK_PACKAGE_DATADIR nil t nil) )

(defun SKK-MK-cleanup-trouble-makers (&optional backup)
  (let ((dirs
	 (if (boundp 'package-locations)
	     (let ((l
		    (mapcar
		     (function (lambda (d) (expand-file-name "lisp/skk" (car d))))
		     package-locations )))
	       (if early-package-load-path
		   (nconc
		    l 
		    (mapcar
		     (function (lambda (d) (expand-file-name "lisp/skk" d)))
		     early-packages )))
	       (if late-package-load-path
		   (nconc
		    l
		    (mapcar
		     (function (lambda (d) (expand-file-name "lisp/skk" d)))
		     late-packages )))
	       (if last-package-load-path
		   (nconc
		    l
		    (mapcar
		     (function (lambda (d) (expand-file-name "lisp/skk" d)))
		     last-packages )))
	       l )
	   (delq nil
		 (mapcar
		  (function (lambda (d) (if (string-match "skk/*$" d) d)))
		  load-path ))))
	(files '("auto-autoloads.el" "custom-load.el" "skk-autoloads.el"
		 ;; obsolete.
		 "skk-vars.el" ))
	(index0 0) (index1 0) (counter 0) dir file )
    (message "Cleanup trouble makers...")
   (while (setq dir (nth index0 dirs))
     (setq index1 0)
      (while (setq file (nth index1 files))
	(setq file (expand-file-name file dir))
	(condition-case nil
	    (progn
	      (if (file-exists-p file)
		  (progn
		    (if backup
			;; XXX not for ms-dos...
			(copy-file file (concat file ".BAK") t t) )
		    (delete-file file)
		    (setq counter (1+ counter)) ))
	      (if (file-exists-p (concat file "c"))
		  (progn
		    (if backup
			;; XXX not for ms-dos...
			(copy-file (concat file "c") (concat file ".BAK") t t) )
		    (delete-file (concat file "c"))
		    (setq counter (1+ counter)) )))
	  (error) )
	(setq index1 (1+ index1)) )
      (setq index0 (1+ index0)) )
    (message "Cleanup trouble makers...%s files done" counter) ))

(defun SKK-MK-texinfo-format (targets)
  (let (
	;; Emacs20.2's default is 'raw-text-unix.
	(coding-system-for-write SKK-MK-texinfo-coding-system) 
	x obuf beg )
    (while targets
      (setq x (expand-file-name (car targets) DOCDIR))
      (find-file x)
      (setq obuf (current-buffer))
      (condition-case nil
	  (texinfo-format-buffer)
	(error				; one more try with no @direntry
	 ;;(kill-buffer (current-buffer))
	 (set-buffer obuf)
	 (goto-char (point-min))
	 (message "Format failed. Trying no @direntry")
	 (let (buffer-read-only)
	   (when (re-search-forward "@direntry" nil t)
	     (setq beg (match-beginning 0))
	     (when (re-search-forward "@end direntry" nil t)
	       (delete-region beg (match-end 0)) )))
	 (texinfo-format-buffer) ))
      (save-buffer)
      (kill-buffer (current-buffer))	; info
      (kill-buffer obuf)		; texi
      (setq targets (cdr targets)) )))

(defun SKK-MK-what-where ()
  (interactive)
  (SKK-MK-config)
  (let ((string
	 (format "
SKK modules:
  %s
  -> %s

SKK infos:
  %s
  -> %s

SKK tutorials:
  %s
  -> %s
"
		 (mapconcat 'symbol-name SKK_MODULES ", ")
		 SKK_LISPDIR
		 (mapconcat 'identity SKK_INFOS ", ")
		 SKK_INFODIR
		 (mapconcat 'identity SKK_TUTORIALS ", ")
		 SKK_DATADIR )))
    (if (interactive-p)
	(progn (with-output-to-temp-buffer "*What where*" (princ string))
	       (message "") )
      (princ string) )))

(defun SKK-MK-what-where-package ()
  (interactive)
  (SKK-MK-config-package)
  (let ((string
	 (format "
SKK modules:
  %s
  -> %s

SKK infos:
  %s
  -> %s

SKK tutorials:
  %s
  -> %s
"
		 (mapconcat 'symbol-name SKK_MODULES ", ")
		 SKK_PACKAGE_LISPDIR
		 (mapconcat 'identity SKK_INFOS ", ")
		 PACKAGE_INFODIR
		 (mapconcat 'identity SKK_TUTORIALS ", ")
		 SKK_PACKAGE_DATADIR )))
    (if (interactive-p)
	(progn (with-output-to-temp-buffer "*What where*" (princ string))
	       (message "") )
      (princ string) )))

;;; SKK-MK ends here
